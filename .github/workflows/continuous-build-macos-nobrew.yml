name: Continuous Build MacOS Nobrew

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'include/**'
      - 'Makefile'
      - '.github/workflows/continuous-build-macos.yml'

jobs:
  build-macos:
    strategy:
      matrix:
        os:
          - {runner: 'macos-15', version: 'Sequoia'}
    runs-on: ${{ matrix.os.runner }}
    steps:
      - uses: actions/checkout@v6

      # Xcode is pre-installed on GitHub runners, but this ensures a stable path
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Compile
        run: |
          # CXX=clang++ uses the native Apple compiler (no external dylib dependency)
          # STRIP=true removes debug symbols to keep the file small
          # The Makefile will skip manpage generation if lowdown is not found
          make CXX=clang++ STRIP=true
          
          GIT_HASH=$(git rev-parse --short "$GITHUB_SHA")
          mv bin/btop bin/btop-arm64-${{ matrix.os.version }}-$GIT_HASH
          ls -alh bin

      - uses: actions/upload-artifact@v6
        with:
          name: btop-arm64-${{ matrix.os.version }}
          path: 'bin/btop-arm64-*'
